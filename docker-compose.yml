version: '3.8'

services:
  # Local Hardhat Node (Keep available, but default config uses Sepolia)
  hardhat:
    build: ./contracts
    ports:
      - "8545:8545"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8545"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    profiles: ["dev"] # Only start if explicitly requested or needed

  # Backend API
  backend:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3000
      - JWT_SECRET=${JWT_SECRET:-basestack-dev-secret-key-32chars}
      - DATABASE_PATH=/app/data/database.sqlite
      # Using values from .env (Sepolia Base)
      - RPC_URL=${RPC_URL:-https://sepolia.base.org}
      - PRIVATE_KEY=${PRIVATE_KEY:-9e7de06dee83df2c68df96a0a146c2af327edd0f44007fbcf1c9e139fdb2e5d7}
      - CONTRACT_ADDRESS=${CONTRACT_ADDRESS:-0x0F3760BBa51A58EE0cA00ef2582D0cf6DCcAd68c}
      - TOKEN_IDRX=${TOKEN_IDRX:-0xd33a87627b15Df1e4488f41e02E73e1C2CDEb494}
      - TOKEN_USDC=${TOKEN_USDC:-0xCe95Aafe68936cC1c0aFB81b83702D5eD4A9dbf1}
      - TOKEN_USDT=${TOKEN_USDT:-0xB1Fd5170a77f52DF916BBBdC92e7f2EE2fDaf5e2}
    volumes:
      - basestack-data:/app/data
    restart: unless-stopped

  # Frontend Next.js App
  frontend:
    build:
      context: ./frontend
      # Pass build args to bake into the Next.js static build
      args:
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:3000}
        - NEXT_PUBLIC_RPC_URL=${NEXT_PUBLIC_RPC_URL:-https://sepolia.base.org}
        - NEXT_PUBLIC_CONTRACT_ADDRESS=${NEXT_PUBLIC_CONTRACT_ADDRESS:-0x0F3760BBa51A58EE0cA00ef2582D0cf6DCcAd68c}
        - NEXT_PUBLIC_TOKEN_IDRX=${NEXT_PUBLIC_TOKEN_IDRX:-0xd33a87627b15Df1e4488f41e02E73e1C2CDEb494}
        - NEXT_PUBLIC_TOKEN_USDC=${NEXT_PUBLIC_TOKEN_USDC:-0xCe95Aafe68936cC1c0aFB81b83702D5eD4A9dbf1}
        - NEXT_PUBLIC_TOKEN_USDT=${NEXT_PUBLIC_TOKEN_USDT:-0xB1Fd5170a77f52DF916BBBdC92e7f2EE2fDaf5e2}
        - NEXT_PUBLIC_ONCHAINKIT_API_KEY=${NEXT_PUBLIC_ONCHAINKIT_API_KEY}
    ports:
      - "3001:3000"
    environment:
      # Runtime env vars (mostly for SSR or server-side logic)
      - PORT=3000
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:3000}
    depends_on:
      - backend
    restart: unless-stopped

volumes:
  basestack-data:
